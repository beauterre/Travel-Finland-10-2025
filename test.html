<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Modal Lightbox ‚Äî Corrected Rotation & Sizing</title>
<style>
  :root { --overlay-pad: 0.05; }
  body { margin:0; font-family:Arial,Helvetica,sans-serif; background:#f0f8ff; }
  h1 { text-align:center; margin:18px 0; }
  #gallery { display:flex; gap:12px; padding:16px; overflow-x:auto; }
  .thumb { flex:0 0 150px; height:100px; border-radius:8px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.15); cursor:pointer; position:relative; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .thumb.video .play-btn { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:40px; height:40px; border-radius:50%; background:rgba(0,0,0,.65); color:#fff; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,.85); justify-content:center; align-items:center; z-index:9999; }
  .modal-content {
    position:relative;
    background:#fff;
    border-radius:12px;
    overflow:visible;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    box-sizing:border-box;
    border:2px solid rgba(255,255,255,0.85);
    transition:all 0.18s ease;
    will-change:width,height;
  }
  #modal-media { display:block; transform-origin:center center; }
  .close-btn { position:absolute; right:10px; top:10px; background:#fff; border-radius:50%; width:34px; height:34px; text-align:center; line-height:34px; font-size:20px; cursor:pointer; z-index:20; }
  .controls { position:absolute; top:10px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:20; }
  .control-btn { width:40px; height:40px; border-radius:50%; background:rgba(0,0,0,.6); color:#fff; border:none; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
</style>
</head>
<body>
  <h1>Gallery with proper rotated modal sizing</h1>
  <div id="gallery"></div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" id="modalContent">
      <span id="closeBtn" class="close-btn" title="Close">&times;</span>
      <div id="modal-media"></div>
      <div class="controls">
        <button id="prevBtn" class="control-btn" title="Previous">‚ùÆ</button>
        <button id="rotateBtn" class="control-btn" title="Rotate">üîÑ</button>
        <button id="nextBtn" class="control-btn" title="Next">‚ùØ</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Data ---------- */
const photoPath = "./fotos/Dag9/";
const items = [
  { kind: "image", url: "Screenshot_20251010-175907.png" },
  { kind: "youtube", id: "JYt82UGhnOM" },
  { kind: "youtube", id: "uk500H2d274" },
  { kind: "image", url: "IMG-20251010-WA0003.jpeg" }
];

/* ensure angle persistence */
items.forEach(i => { if (typeof i.angle !== 'number') i.angle = 0; });

/* ---------- State & refs ---------- */
let currentIndex = -1;
let rotationAngle = 0;
const gallery = document.getElementById('gallery');
const modal = document.getElementById('modal');
const modalMedia = document.getElementById('modal-media');
const modalContent = document.getElementById('modalContent');
const rotateBtn = document.getElementById('rotateBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const closeBtn = document.getElementById('closeBtn');

/* ---------- Thumbnails ---------- */
items.forEach((item, idx) => {
  const t = document.createElement('div');
  t.className = 'thumb' + (item.kind === 'youtube' ? ' video' : '');
  const img = document.createElement('img');
  img.dataset.index = idx;
  if (item.kind === 'image') {
    img.src = photoPath + item.url;
    img.alt = item.url;
  } else {
    img.src = `https://img.youtube.com/vi/${item.id}/hqdefault.jpg`;
    img.alt = 'YouTube thumbnail';
    const play = document.createElement('div'); play.className='play-btn'; play.textContent='‚ñ∂';
    t.appendChild(play);
  }
  t.appendChild(img);
  gallery.appendChild(t);
});

/* ---------- Open modal ---------- */
gallery.addEventListener('click', (ev) => {
  const img = ev.target.closest('.thumb img');
  if (!img) return;
  currentIndex = Number(img.dataset.index);
  rotationAngle = items[currentIndex].angle || 0;
  openModal(currentIndex);
});

function openModal(index) {
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
  showMedia(index);
}
function closeModal() {
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
  modalMedia.innerHTML = '';
}

/* ---------- Core sizing logic (correct math) ---------- */
function showMedia(index) {
  modalMedia.innerHTML = '';
  const item = items[index];
  let el;
  if (item.kind === 'image') {
    el = document.createElement('img');
    el.src = photoPath + item.url;
    el.style.display = 'block';
    el.style.transformOrigin = '50% 50%';
    el.onload = () => {
      const natW = el.naturalWidth || el.width || 800;
      const natH = el.naturalHeight || el.height || 600;
      computeAndApply(el, natW, natH);
    };
    el.onerror = () => computeAndApply(el, 800, 600);
  } else {
    el = document.createElement('iframe');
    el.src = `https://www.youtube.com/embed/${item.id}?autoplay=1`;
    el.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    el.allowFullscreen = true;
    el.style.display = 'block';
    el.style.border = '0';
    el.style.transformOrigin = '50% 50%';
    // assume 16:9 intrinsic
    requestAnimationFrame(() => computeAndApply(el, 1280, 720));
  }
  modalMedia.appendChild(el);
  // set transform to stored angle (in case angle exists)
  el.style.transform = `rotate(${rotationAngle}deg)`;
}

/* compute and apply sizes correctly:
   - s = min(maxW / (intrW*cos + intrH*sin), maxH / (intrW*sin + intrH*cos), 1)
   - displayW = intrW * s; displayH = intrH * s
   - rotW = abs(displayW*cos) + abs(displayH*sin)
   - rotH = abs(displayW*sin) + abs(displayH*cos)
   - set media size to displayW/displayH, modal-content to rotW/rotH, rotate media
*/
function computeAndApply(mediaEl, intrW, intrH) {
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const padRatio = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--overlay-pad')) || 0.05;
  const maxW = Math.max(100, vw * (1 - 2 * padRatio));
  const maxH = Math.max(100, vh * (1 - 2 * padRatio));

  const a = rotationAngle % 360;
  const rad = a * Math.PI / 180;
  const cos = Math.abs(Math.cos(rad));
  const sin = Math.abs(Math.sin(rad));

  const denomW = intrW * cos + intrH * sin;
  const denomH = intrW * sin + intrH * cos;

  const sW = denomW > 0 ? maxW / denomW : 1;
  const sH = denomH > 0 ? maxH / denomH : 1;
  const s = Math.min(sW, sH, 1);

  const displayW = Math.round(intrW * s);
  const displayH = Math.round(intrH * s);

  const rotW = Math.round(Math.abs(displayW * Math.cos(rad)) + Math.abs(displayH * Math.sin(rad)));
  const rotH = Math.round(Math.abs(displayW * Math.sin(rad)) + Math.abs(displayH * Math.cos(rad)));

  // Apply to media element (unrotated size)
  mediaEl.style.width = displayW + 'px';
  mediaEl.style.height = displayH + 'px';
  mediaEl.style.maxWidth = 'none';
  mediaEl.style.maxHeight = 'none';

  // Apply modal container to rotated bounding box
  modalContent.style.width = rotW + 'px';
  modalContent.style.height = rotH + 'px';

  // apply rotation (keeps centered)
  mediaEl.style.transform = `rotate(${rotationAngle}deg)`;
}

/* ---------- Controls ---------- */
rotateBtn.addEventListener('click', () => {
  rotationAngle = (rotationAngle + 90) % 360;
  items[currentIndex].angle = rotationAngle; // persist
  const el = modalMedia.firstElementChild;
  if (!el) return;
  // recompute using intrinsic sizes
  const intrW = (el.tagName === 'IFRAME') ? 1280 : (el.naturalWidth || el.width || 800);
  const intrH = (el.tagName === 'IFRAME') ? 720 : (el.naturalHeight || el.height || 600);
  computeAndApply(el, intrW, intrH);
});

nextBtn.addEventListener('click', () => {
  currentIndex = (currentIndex + 1) % items.length;
  rotationAngle = items[currentIndex].angle || 0;
  showMedia(currentIndex);
});
prevBtn.addEventListener('click', () => {
  currentIndex = (currentIndex - 1 + items.length) % items.length;
  rotationAngle = items[currentIndex].angle || 0;
  showMedia(currentIndex);
});

closeBtn.addEventListener('click', closeModal);
window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

window.addEventListener('resize', () => {
  const el = modalMedia.firstElementChild;
  if (!el) return;
  const intrW = (el.tagName === 'IFRAME') ? 1280 : (el.naturalWidth || el.width || 800);
  const intrH = (el.tagName === 'IFRAME') ? 720 : (el.naturalHeight || el.height || 600);
  computeAndApply(el, intrW, intrH);
});
</script>
</body>
</html>
